name: "Build & Publish Docker Image"

# trigger events
on:
  # # Manual
  # workflow_dispatch:

  # Automatic
  release:
    types: [created]

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}
  CONTAINER_PLATFORM: linux/amd64,linux/arm64

jobs:

  build-push:
    if: ${{ github.event_name != 'pull_request' }}
    
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      packages: write
      contents: read
      attestations: write

    steps:

      # Pull Source Code
      - name: Checkout repository
        uses: actions/checkout@v5

      # Add support for more platforms with QEMU
      # https://github.com/docker/setup-qemu-action

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Set up Docker for Buildx env
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login
      - name: ðŸ” Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Determine image tags
      - name: Determine image tags
        id: tags
        run: |
          # Use release tag ref if present, else fallback to release.tag_name or release.name
          TAG="${GITHUB_REF#refs/tags/}"
          if [ -z "$TAG" ]; then
            TAG="${{ github.event.release.tag_name }}"
          fi
          if [ -z "$TAG" ]; then
            TAG="${{ github.event.release.name }}"
          fi
          # strip leading v or V (so v1.2.3 -> 1.2.3)
          TAG="${TAG#v}"
          TAG="${TAG#V}"
          # sanitize tag (keep . _ -)
          TAG_SAFE="$(echo "$TAG" | sed -E 's/[^A-Za-z0-9._-]/_/g')"
          echo "tag=$TAG_SAFE" >> $GITHUB_OUTPUT
          # Add 'latest' for non-prerelease releases
          if [ "${{ github.event.release.prerelease }}" = "false" ]; then
            echo "add_latest=true" >> $GITHUB_OUTPUT
          else
            echo "add_latest=false" >> $GITHUB_OUTPUT
          fi

      # Determine docker args
      - name: Normalize pb platform and version 
        id: set-platform
        run: |
          PLAT="${{ env.CONTAINER_PLATFORM }}"
          # determine PB_PLATFORM: prefer amd64 then arm64, else first entry (strip 'linux/')
          if echo "$PLAT" | grep -q 'linux/amd64'; then
            PB=amd64
          elif echo "$PLAT" | grep -q 'linux/arm64'; then
            PB=arm64
          else
            PB="$(echo "$PLAT" | cut -d',' -f1 | sed -E 's@.*/@@')"
          fi

          # determine PB_VERSION using same logic as tags step
          TAG="${GITHUB_REF#refs/tags/}"
          if [ -z "$TAG" ]; then
            TAG="${{ github.event.release.tag_name }}"
          fi
          if [ -z "$TAG" ]; then
            TAG="${{ github.event.release.name }}"
          fi
          TAG="${TAG#v}"
          TAG="${TAG#V}"
          VER_SAFE="$(echo "$TAG" | sed -E 's/[^A-Za-z0-9._-]/_/g')"

          echo "pb_platform=$PB" >> $GITHUB_OUTPUT
          echo "pb_version=$VER_SAFE" >> $GITHUB_OUTPUT
          echo "buildx_platforms=${PLAT}" >> $GITHUB_OUTPUT

      # Build Docker image & Push
      - name: Build and push image
        uses: docker/build-push-action@v6
        id: push
        with:
          context: .
          platforms: ${{ steps.set-platform.outputs.buildx_platforms }}
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.tag }}
            ${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
          file: ./Dockerfile
          build-args: |
            PB_PLATFORM=${{ steps.set-platform.outputs.pb_platform }}
            PB_VERSION=${{ steps.set-platform.outputs.pb_version }}

      # Attest Docker image & Push digest
      - name: Attest
        uses: actions/attest-build-provenance@v3
        id: attest
        with:
          subject-name: ${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

      # Tag Docker image with :latest only if its release
      - name: Push latest tag (if release)
        if: steps.tags.outputs.add_latest == 'true'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
          docker pull "${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.tag }}" || exit 1
          docker tag "${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.tag }}" "${{ env.IMAGE_NAME }}:latest"
          docker push "${{ env.IMAGE_NAME }}:latest"